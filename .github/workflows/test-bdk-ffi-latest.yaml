name: Test on BDK-FFI Latest Commit

on:
  push:
      branches: [ "test/workflow" ]
  workflow_dispatch:
  repository_dispatch:
    types: [ trigger-bdk-python-test ]

permissions: {}

jobs:
  test-bdk-ffi-latest-manylinux_2_28-x86_64-wheels:
    name: "Build and run unittest on Manylinux 2.28 x86_64 wheels against the latest commit on bdk-ffi"
    runs-on: ubuntu-24.04
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
      env:
        PLAT: manylinux_2_28_x86_64
        PYBIN: "/opt/python/${{ matrix.python }}/bin"
    strategy:
      matrix:
        python:
          - cp310-cp310
          - cp311-cp311
          - cp312-cp312
          - cp313-cp313
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          fetch-depth: 0

      - name: "Configure Git safe directory"
        run: git config --global --add safe.directory /__w/bdk-python/bdk-python

      - name: "Update bdk-ffi submodule to latest"
        run: |
          cd ./bdk-ffi/ \
          && git fetch origin \
          && git checkout master \
          && git pull origin master \
          && echo "Testing commit: $(git log -1 --pretty=format:'%h %s (author: %cn)')"

      - name: "Cache"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./target
          key: ${{ runner.os }}-${{ hashFiles('**/Cargo.toml','*Cargo.lock') }}

      - name: Install rustup, if needed
        shell: bash
        run: |
          if ! command -v rustup &> /dev/null ; then
            curl --proto '=https' --tlsv1.2 --retry 10 --retry-connrefused -fsSL "https://sh.rustup.rs" | sh -s -- --default-toolchain none -y

            # Resolve the correct CARGO_HOME path depending on OS
            if [[ "$RUNNER_OS" == "Windows" ]]; then
              echo "${CARGO_HOME:-$USERPROFILE/.cargo}/bin" | sed 's|/|\\|g' >> $GITHUB_PATH
            else
              echo "${CARGO_HOME:-$HOME/.cargo}/bin" >> $GITHUB_PATH
            fi
          fi
        env:
          RUNNER_OS: "${{ runner.os }}"

      - name: rustup toolchain install ${{inputs.toolchain || 'stable'}}
        env:
          toolchain: null
          targets: null
          components: clippy
          override: true
          rust_src_dir: "./bdk-ffi/bdk-ffi"
        shell: bash
        run: |
          echo "Current Directory: $(pwd)"
          echo "Rust Source Directory: $rust_src_dir"
          echo "Toolchain: $toolchain"
          echo "Targets: $targets"
          echo "Components: $components"
          echo "Override: $override"

          if [[ -d "$rust_src_dir" ]]; then
            cd "$rust_src_dir"
            echo "Changed directory to: $(pwd)"
          fi

          if [[ -z "$toolchain" && ( -f "rust-toolchain" || -f "rust-toolchain.toml") ]]; then
            echo "Installing toolchain from rust-toolchain file..."
            rustup show active-toolchain || rustup toolchain install
            if [[ $? -ne 0 ]]; then
              echo "Error: Failed to install toolchain from rust-toolchain file."
              exit 1
            fi

            TOOLCHAIN=$(rustup show active-toolchain | awk '{print $1}' | cut -d- -f1)
            echo "Setting override and default to toolchain: $TOOLCHAIN"
            rustup override set "$TOOLCHAIN"
            rustup default "$TOOLCHAIN"

            if [[ -n $components ]]; then
              echo "Adding components: ${components//,/ }"
              rustup component add ${components//,/ }
            fi
            if [[ -n $targets ]]; then
              echo "Adding targets: ${targets//,/ }"
              rustup target add ${targets//,/ }
            fi
          else
            if [[ -z "$toolchain" ]]; then
              toolchain=stable
            fi
            echo "Installing specified toolchain: ${toolchain//,/ }"
            rustup toolchain install ${toolchain//,/ } ${{steps.flags.outputs.targets}}${{steps.flags.outputs.components}} --profile minimal${{steps.flags.outputs.downgrade}} --no-self-update
            if [[ $? -ne 0 ]]; then
              echo "Error: Failed to install specified toolchain."
              exit 1
            fi
            if [[ "$override" == "true" ]]; then
              echo "Setting override to toolchain: ${toolchain//*,/ }"
              rustup override set ${toolchain//*,/ }
            fi
          fi
      
      - name: Print installed versions
        shell: bash
        run: |
          echo "rustc-version=$(rustc --version)" >> $GITHUB_OUTPUT
          rustc --version --verbose
          echo "cargo-version=$(cargo --version)" >> $GITHUB_OUTPUT
          cargo --version --verbose
          echo "rustup-version=$(rustup --version)" >> $GITHUB_OUTPUT
          rustup --version

          DATE=$(rustc --version --verbose | sed -ne 's/^commit-date: \(20[0-9][0-9]\)-\([01][0-9]\)-\([0-3][0-9]\)$/\1\2\3/p')
          HASH=$(rustc --version --verbose | sed -ne 's/^commit-hash: //p')
          echo "cachekey=$(echo $DATE$HASH | head -c12)" >> $GITHUB_OUTPUT

      - name: "Generate bdk.py and binaries"
        run: bash ./scripts/generate-linux.sh

      - name: "Install build"
        run: ${PYBIN}/pip install build

      - name: "Build wheel"
        run: ${PYBIN}/python -m build --wheel --config-setting=--build-option=--plat-name=manylinux_2_28_x86_64 --verbose

      - name: "Install wheel"
        run: ${PYBIN}/pip install ./dist/*.whl

      - name: "Run tests"
        run: ${PYBIN}/python -m unittest discover --start "./tests/" --pattern "test_offline_*.py" --verbose

      - name: "Upload artifact test"
        uses: actions/upload-artifact@v4
        with:
          name: bdkpython-manylinux_2_28_x86_64-${{ matrix.python }}
          path: /home/runner/work/bdk-python/bdk-python/dist/*.whl

  test-bdk-ffi-latest-macos-arm64-wheels:
    name: "Build and run unittest on macOS arm64 wheels against the latest commit on bdk-ffi"
    runs-on: macos-14
    strategy:
      matrix:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          fetch-depth: 0
      
      - name: "Update bdk-ffi submodule to latest"
        run: |
          cd ./bdk-ffi/ \
          && git fetch origin \
          && git checkout master \
          && git pull origin master \
          && echo "Testing commit: $(git log -1 --pretty=format:'%h %s (author: %cn)')"

      - name: "Cache"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./target
          key: ${{ runner.os }}-${{ hashFiles('**/Cargo.toml','**/Cargo.lock') }}

      - name: "Install Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: "Generate bdk.py and binaries"
        run: bash ./scripts/generate-macos-arm64.sh

      - name: "Install build"
        run: pip3 install build

      - name: "Build wheel"
        # Specifying the plat-name argument is necessary to build a wheel with the correct name,
        # see issue #350 for more information
        run: python3 -m build --wheel --config-setting=--build-option=--plat-name=macosx_11_0_arm64 --verbose

      - name: "Install wheel"
        run: pip3 install ./dist/*.whl
          
      - name: "Run tests"
        run: python3 -m unittest discover --start "./tests/" --pattern "test_offline_*.py" --verbose

      - name: "Upload artifact test"
        uses: actions/upload-artifact@v4
        with:
          name: bdkpython-macos-arm64-${{ matrix.python }}
          path: /Users/runner/work/bdk-python/bdk-python/dist/*.whl

  test-bdk-ffi-latest-macos-x86_64-wheels:
    name: "Build and run unittest on macOS x86_64 wheels against the latest commit on bdk-ffi"
    runs-on: macos-15-intel
    strategy:
      matrix:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          fetch-depth: 0

      - name: "Update bdk-ffi submodule to latest"
        run: |
          cd ./bdk-ffi/ \
          && git fetch origin \
          && git checkout master \
          && git pull origin master \
          && echo "Testing commit: $(git log -1 --pretty=format:'%h %s (author: %cn)')"

      - name: "Cache"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./target
          key: ${{ runner.os }}-${{ hashFiles('**/Cargo.toml','**/Cargo.lock') }}

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: "Generate bdk.py and binaries"
        run: bash ./scripts/generate-macos-x86_64.sh

      - name: "Install build"
        run: pip3 install build

      - name: "Build wheel"
        run: python3 -m build --wheel --config-setting=--build-option=--plat-name=macosx_11_0_x86_64 --verbose

      - name: "Install wheel"
        run: pip3 install ./dist/*.whl

      - name: "Run tests"
        run: python3 -m unittest discover --start "./tests/" --pattern "test_offline_*.py" --verbose

      - name: "Upload artifact test"
        uses: actions/upload-artifact@v4
        with:
          name: bdkpython-macos-x86_64-${{ matrix.python }}
          path: /Users/runner/work/bdk-python/bdk-python/dist/*.whl

  test-bdk-ffi-latest-windows-wheels:
    name: "Build and run unittest on Windows wheels against the latest commit on bdk-ffi"
    runs-on: windows-2022
    strategy:
      matrix:
        python:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          fetch-depth: 0

      - name: "Update bdk-ffi submodule to latest"
        run: |
          cd ./bdk-ffi/; 
          git fetch origin; 
          git checkout master; 
          git pull origin master; 
          echo "Testing commit: $(git log -1 --pretty=format:'%h %s (author: %cn)')"

      - name: "Cache"
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ./target
          key: ${{ runner.os }}-${{ hashFiles('**/Cargo.toml','**/Cargo.lock') }}
      
      - name: "Install Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}

      - name: "Generate bdk.py and binaries"
        run: bash ./scripts/generate-windows.sh

      - name: "Install build"
        run: pip install build

      - name: "Build wheel"
        run: python -m build --wheel --verbose

      - name: "Upload artifact test"
        uses: actions/upload-artifact@v4
        with:
          name: bdkpython-windows-${{ matrix.python }}
          path: D:\a\bdk-python\bdk-python\dist\*.whl

      - name: "Install dependencies"
        run: Get-ChildItem 'D:\a\bdk-python\bdk-python\dist\*.whl' | ForEach-Object {pip install $_.FullName}
        shell: powershell

      - name: "Run tests"
        run: python -m unittest discover --start "./tests/" --pattern "test_offline_*.py" --verbose

  ruff:
    name: "Lint tests"
    runs-on: ubuntu-24.04
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          submodules: recursive
          persist-credentials: false
          fetch-depth: 0

      - name: "Configure Git safe directory"
        run: git config --global --add safe.directory /__w/bdk-python/bdk-python

      - name: "Install Ruff"
        run: curl -LsSf https://astral.sh/ruff/install.sh | sh

      - name: "Lint test targets"
        run: ruff check ./tests/